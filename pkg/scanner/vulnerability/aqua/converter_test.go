package aqua

import (
	"os"
	"testing"

	"github.com/aquasecurity/starboard-security-operator/pkg/etc"
	"github.com/aquasecurity/starboard/pkg/apis/aquasecurity/v1alpha1"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestConverter_Convert(t *testing.T) {
	testCases := []struct {
		name string

		expectedReport v1alpha1.VulnerabilityReport
	}{
		{
			name: "test_fixtures/aqua_csp_report/without_vulnerabilities.json",
			expectedReport: v1alpha1.VulnerabilityReport{
				Scanner: v1alpha1.Scanner{
					Name:    "Aqua CSP",
					Vendor:  "Aqua Security",
					Version: "4.6",
				},
				Registry:        v1alpha1.Registry{},
				Artifact:        v1alpha1.Artifact{},
				Vulnerabilities: []v1alpha1.VulnerabilityItem{},
			},
		},
		{
			name: "test_fixtures/aqua_csp_report/with_vulnerabilities.json",
			expectedReport: v1alpha1.VulnerabilityReport{
				Scanner: v1alpha1.Scanner{
					Name:    "Aqua CSP",
					Vendor:  "Aqua Security",
					Version: "4.6",
				},
				Registry: v1alpha1.Registry{},
				Artifact: v1alpha1.Artifact{},
				Summary: v1alpha1.VulnerabilitySummary{
					HighCount:   2,
					MediumCount: 2,
				},
				Vulnerabilities: []v1alpha1.VulnerabilityItem{
					{
						VulnerabilityID:  "DSA-4685-1",
						Resource:         "apt",
						InstalledVersion: "1.8.2",
						FixedVersion:     "1.8.2.1",
						Severity:         "MEDIUM",
						Links: []string{
							"https://security-tracker.debian.org/tracker/DSA-4685-1",
						},
					},
					{
						VulnerabilityID:  "CVE-2020-3910",
						Resource:         "libxml2",
						InstalledVersion: "2.9.4+dfsg1-7+b3",
						Severity:         "HIGH",
						Description:      "Description of CVE-2020-3910",
						Links: []string{
							"https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2020-3910",
							"https://security-tracker.debian.org/tracker/CVE-2020-3910",
						},
					},
					{
						VulnerabilityID:  "CVE-2020-3909",
						Resource:         "libxml2",
						InstalledVersion: "2.9.4+dfsg1-7+b3",
						Severity:         "HIGH",
						Description:      "Description of CVE-2020-3909",
						Links: []string{
							"https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2020-3909",
							"https://security-tracker.debian.org/tracker/CVE-2020-3909",
						},
					},
					{
						VulnerabilityID:  "CVE-2020-11724",
						Resource:         "nginx",
						InstalledVersion: "1.16.1-1~buster",
						Severity:         "MEDIUM",
						Description:      "Description of CVE-2020-11724",
						Links: []string{
							"https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2020-11724",
							"https://security-tracker.debian.org/tracker/CVE-2020-11724",
						},
					},
				},
			},
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			testFile, err := os.Open(tc.name)
			require.NoError(t, err)
			defer func() {
				_ = testFile.Close()
			}()

			report, err := NewConverter(etc.ScannerAquaCSP{Version: "4.6"}).Convert(testFile)
			require.NoError(t, err)

			assert.Equal(t, tc.expectedReport, report)
		})
	}
}
